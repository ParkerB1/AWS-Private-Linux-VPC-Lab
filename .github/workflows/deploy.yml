name: CI/CD Deploy Private App

on:
  push:
      branches: [ main ]

jobs:
  deploy:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout Code
          uses: actions/checkout@v4

        - name: Copy files to private EC2 via Bastion
          uses: appleboy/scp-action@master
          with:
            host: ${{ secrets.PRIVATE_EC2_IP }}
            username: ec2-user
            key: ${{ secrets.PRIVATE_EC2_KEY }}
            port: 22
            source: "app.py"
            target: "/opt/app/"
            proxy: ${{ secrets.BASTION_HOST }}
            proxy_user: ${{ secrets.BASTION_USER }}
            proxy_key: ${{ secrets.BASTION_KEY }}


        - name: Restart app service
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.BASTION_HOST }}
            username: ${{ secrets.BASTION_USER }}
            key: ${{ secrets.BASTION_KEY }}
            port: 22
            script: |
              set -e #Exits immediately if any command fails
  
              # cleaning out the app directory
              ssh -i ~/.ssh/private_ec2_key -o StrictHostKeyChecking=no ***@*** "rm -rf /opt/app/*"

              # Pull latest repo or clone if it doesn't exit
              if [ -d ~/deploy ]; then
                cd ~/deploy
                git reset --hard
                git clean -fd
                git pull origin main
              else
                git clone https://github.com/ParkerB1/AWS-Private-Linux-VPC-Lab.git ~/deploy
                cd ~/deploy
              fi
  
              # Copy files to private EC2 via SSH from bastion
              echo "Copying repo to private EC2..."
              scp -i ~/.ssh/private_ec2_key -o StrictHostKeyChecking=no -r ./app.py ***@***:/opt/app
  
              # SSH into private ec2 and restart app
              echo "Restarting app service on private EC2..."
              ssh -i ~/.ssh/private_ec2_key -o StrictHostKeyChecking=no ***@*** << 'EOF'
                sudo systemctl restart app.service
              EOF
